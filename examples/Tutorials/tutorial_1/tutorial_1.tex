% !TEX TS-program = pdflatex
% !TEX encoding = UTF-8 Unicode

% This is a simple template for a LaTeX document using the "article" class.
% See "book", "report", "letter" for other types of document.

\documentclass[11pt]{article} % use larger type; default would be 10pt
\usepackage[most]{tcolorbox}

\tcbset{
    frame code={}
    center title,
    left=0pt,
    right=0pt,
    top=0pt,
    bottom=0pt,
    colback=lightgray!70,
    colframe=white,
    width=\dimexpr\textwidth\relax,
    enlarge left by=0mm,
    boxsep=5pt,
    arc=0pt,outer arc=0pt,
    }
    
    
\usepackage[utf8]{inputenc} % set input encoding (not needed with XeLaTeX)}
%\usepackage{biblatex}
%\addbibresource{phd_thesis.bib}
\usepackage{filecontents}
\usepackage{natbib}
\usepackage{bibentry}
\usepackage{hyperref}
\usepackage{fancyvrb}
\nobibliography*


%%% Examples of Article customizations
% These packages are optional, depending whether you want the features they provide.
% See the LaTeX Companion or other references for full information.

%%% PAGE DIMENSIONS
\usepackage{geometry} % to change the page dimensions
\geometry{a4paper} % or letterpaper (US) or a5paper or....
% \geometry{margin=2in} % for example, change the margins to 2 inches all round
% \geometry{landscape} % set up the page for landscape
%   read geometry.pdf for detailed page layout information

\usepackage{graphicx} % support the \includegraphics command and options
\usepackage{url}
\usepackage{bm}
\usepackage{amssymb}
% \usepackage[parfill]{parskip} % Activate to begin paragraphs with an empty line rather than an indent

%%% PACKAGES
\usepackage{booktabs} % for much better looking tables
\usepackage{array} % for better arrays (eg matrices) in maths
\usepackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\usepackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\usepackage{subfig} % make it possible to include more than one captioned figure/table in a single float
% These packages are all incorporated in the memoir class to one degree or another...

%%% HEADERS & FOOTERS
\usepackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}

%%% SECTION TITLE APPEARANCE
\usepackage{sectsty}
\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
% (This matches ConTeXt defaults)

%%% ToC (table of contents) APPEARANCE
\usepackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\usepackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

%%% END Article customizations

%%% The "real" document content comes below...

\title{Configuration files}
\date{\today} % Activate to display a given date or no date (if empty),
         % otherwise the current date is printed 

\begin{document}
TH LFNS toolbox, as well as examples and this very tutorial can be found on \href{https://github.com/Mijan/LFNS}{github}, it can be downloaded using 

\begin{tcolorbox}
\begin{verbatim}
git clone https://github.com/Mijan/LFNS.git
\end{verbatim}
\end{tcolorbox}

This allows in particular to use

\begin{tcolorbox}
\begin{verbatim}
git pull
\end{verbatim}
\end{tcolorbox}
 to get all latest versions and updates. 
\section{Installation}
The first exercise is to get the LFNS toolbox ready to be used. This can be done in one of the following three ways: 
\subsection{Install the toolbox on a Unix-based system}
The most straight forward way to use the toolbox is to install it using cmake. On Linux systems (and for the most part Mac systems) this can be done fairly easily by first cloning the git repository (by typing \texttt{git clone https://github.com/Mijan/LFNS.git}) and following the instructions on \href{https://mijan.github.io/LFNS/}{https://mijan.github.io/LFNS/}. 

\subsection{Use LFNS in a Docker container (all system)}
You can download and install Docker for any operating system and running the LFNS Docker image. For this follow the following steps: 
\begin{itemize}
	\item Download Docker from \href{https://www.docker.com/get-started}{https://www.docker.com/get-started} and install it using the instruction. 
	\item Download the docker image file lfns.tar from \href{ https://polybox.ethz.ch/index.php/s/XOwXhgB10BRbYaE}{ https://polybox.ethz.ch/index.php/s/XOwXhgB10BRbYaE} and the run script from \href{https://polybox.ethz.ch/index.php/s/EPOkSU0Z7EhL0sJ}{https://polybox.ethz.ch/index.php/s/EPOkSU0Z7EhL0sJ}. 
	\item Put the lfns.tar file and the run\_lfns.sh into the same folder, which we will refer to \texttt{/lfns}. 
	\item Make sure the script run\_lfns.sh is executable. This can be done in most OS by right clicking it and clicking a button. 
	\item Load the docker image lfns.tar by typing \texttt{docker load < lfns.tar}. 
	\item Run the docker image by running the provided script by typing \texttt{sh run\_lfns.sh}. This will run the docker image in interactive mode and will mount the current folder on docker. Now you should be able to just type the lfns commands in the console. To test this you can type \texttt{simulate --help}. If this produces a help message, everything went well!
\end{itemize}

\subsection{Install LFNS on Euler}
It might be the easiest to install the LFNS toolbox on Euler and use it there. 
\begin{itemize}
	\item Log into Euler (from a console you can type \texttt{ssh your-user-name@euler.ethz.ch})
	\item Clone the git repository by typing
	\begin{tcolorbox}
\begin{verbatim}
git clone https://github.com/Mijan/LFNS.git
\end{verbatim}
\end{tcolorbox}
	\item The git repository comes with a script file to install all the required libraries and toolbox on euler. To run the script change the directory to \texttt{\$HOME/LFNS/scripts} and call the script \texttt{euler\_install\_script.sh}
	\begin{tcolorbox}
\begin{verbatim}
cd LFNS/scripts
source euler_installation_script.sh
\end{verbatim}
\end{tcolorbox}
\item To make sure that Euler saves the location of the installation path, open the \texttt{.bashrc} file in the home folder and add the following lines
	\begin{tcolorbox}
\begin{verbatim}
module load open_mpi boost/1.59.0
export LD_LIBRARY_PATH=$HOME/local/lib:$HOME/local/lib64:$LD_LIBRARY_PATH
export LIBRARY_PATH=$HOME/local/lib:$HOME/local/lib64:$LIBRARY_PATH
export CPATH=$HOME/local/include:$CPATH
export PATH=$HOME/local/bin:$PATH
export CPPFLAGS="${CPPFLAGS} -I${BOOST_INCLUDEDIR}"
export LDFLAGS="-L${BOOST_LIBRARYDIR} ${LDFLAGS}"
\end{verbatim}
\end{tcolorbox}
\item You can test if everything has worked by typing \texttt{simulate --help}, which should produce a help message. 
\end{itemize}

\section{The antithetic controller}
In this exercise you will write the model files for the antithetic controller and simulate it. For information about the files see the document \href{https://github.com/Mijan/LFNS/blob/publishable/Documentation/doc.pdf}{doc.pdf} (either online or in the folder LFNS/Documentation). 
\subsection{Write the model files}
The model reaction for the antithetic controller has 3 species $z1$, $z2$ and $x1$, The reactions follow mass action kinetics and the reaction are
$$
\begin{array}{l c r c r}
\emptyset & \rightarrow & z1 & \textnormal{at rate} & \mu\\
z1 & \rightarrow & z1 + x1& \textnormal{at rate} & k \\
x1 & \rightarrow & \emptyset & \textnormal{at rate} & \gamma\\
x1 & \rightarrow & x1 + z2 & \textnormal{at rate} & \theta\\
z1 + z2& \rightarrow & \emptyset & \textnormal{at rate} & \eta\\
\end{array}
$$

Use the templates in the \texttt{antithetic/} folder and edit the files \texttt{antithetic\_model.txt}, \texttt{antithetic\_initial.txt} and \texttt{antithetic\_measurement.txt} to represent the above model. As initial conditions, set all the species to 0, and for a measurement take the species $x1$ and add a Gaussion noise with mean $0$ and standard deviation 0.1.

\subsection{Write the config file}
\begin{itemize}
\item Modify the \texttt{<model>} and the \texttt{<Simulation>} block of the file \texttt{antithetic\_config\_file.xml} to contain the relative paths of your model files and specify the parameter to be simulated to all be set to 1. Specify the model type to be deterministic \texttt{<type>DET</type>}
\item Simulate the antithetic model by typing \texttt{simulate antithetic\_config\_file.xml}. This command should simulate the system and produce a number of output files in the same folder as the \texttt{simulate antithetic\_config\_file.xml} file.
\item Take a look at the \texttt{results\_model\_summary.txt} file to make sure the simulated system is the correct one. 
\item You can use the script \texttt{LFNS/scripts/plotSystem.m} to plot the system using matlab. For this type \texttt{plotSystem(results\_model\_summary.txt)}. 
\item Change the model type in the \texttt{antithetic\_config\_file.xml} under \texttt{<type>} to STOCH to simulate the system using SSA. Call the simulate command with the option \texttt{-n 100} to simulate 100 SSA trajectories. Use again the \texttt{plotSystem} command to plot the simulation outcome. 
\item You can simulate the system again and play around with the option (you can see a list of them by typing \texttt{simulate --help}. 
\end{itemize}

\subsection{Add a perturbation to the antithetic model}
Now modify the model files to contain a system perturbation. 
\begin{itemize}
\item Modify the \texttt{antithetic\_model.txt} file by adding another parameter \texttt{pert} that is added to the propensity of the production propensity of \texttt{x1}. 
\item Add an \texttt{<inputs>} block to the \texttt{antithetic\_config\_file.xml} that defines a new experiment and sets the parameter value of \texttt{pert} to 1 in the times between 10 and 50 minutes.
\item Add an \texttt{<experiments>} entry to the \texttt{<Simulation>} block in the \texttt{antithetic\_config\_file.xml} and make sure the experiment name is the same as in the \texttt{<experiments>} entry in the \texttt{<input>} block. 
\item Simulate the new experiment and plot the system states. 
\end{itemize}
  
\end{document}
